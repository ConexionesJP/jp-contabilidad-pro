<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JP ERP ULTIMATE | Impresión Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --main: #00d2ff; --accent: #bc13fe; --bg: #05050a; --card: #12121f; --text: #f0f0f0; --success: #00ff88; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Estilos de la App */
        .sidebar { width: 260px; background: #000; padding: 30px 20px; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .nav-item { padding: 16px; border-radius: 12px; cursor: pointer; transition: 0.3s; margin-bottom: 8px; display: flex; align-items: center; gap: 15px; color: #777; }
        .nav-item:hover, .nav-item.active { background: rgba(0,210,255,0.1); color: var(--main); }
        .main { flex: 1; padding: 40px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; border: 1px solid #222; margin-bottom: 25px; }

        input, select { width: 100%; padding: 14px; background: #080810; border: 1px solid #333; border-radius: 12px; color: white; margin: 10px 0; }
        .btn { border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s; text-transform: uppercase; }
        .btn-main { background: var(--main); color: #000; }
        .btn-accent { background: var(--accent); color: #fff; }
        .btn-print { background: #fff; color: #000; margin-top: 15px; display: none; }

        /* ESTILOS DE IMPRESIÓN (OCULTOS EN PANTALLA) */
        #ticket-print { display: none; }
        @media print {
            body * { visibility: hidden; }
            #ticket-print, #ticket-print * { visibility: visible; }
            #ticket-print { display: block; position: absolute; left: 0; top: 0; width: 80mm; color: #000; background: #fff; padding: 10px; font-family: 'Courier New', Courier, monospace; }
            .no-print { display: none; }
        }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #222; text-align: left; }
    </style>
</head>
<body>

    <nav class="sidebar no-print">
        <h2 style="color:var(--main); text-align:center;">JP ERP PRO</h2>
        <div class="nav-item active" onclick="showPage('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</div>
        <div class="nav-item" onclick="showPage('inventario', this)"><i class="fas fa-boxes"></i> Inventario</div>
        <div class="nav-item" onclick="showPage('ventas', this)"><i class="fas fa-cash-register"></i> Ventas</div>
        <div class="nav-item" onclick="finalizarDia()" style="margin-top:auto; color:#ff4d4d;"><i class="fas fa-power-off"></i> Cierre</div>
    </nav>

    <div class="main no-print">
        <div id="dashboard" class="page active">
            <h1>Dashboard</h1>
            <div class="card"><canvas id="ventasChart" height="100"></canvas></div>
        </div>

        <div id="inventario" class="page">
            <h1>Inventario</h1>
            <div class="card">
                <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap:10px;">
                    <input type="text" id="in-n" placeholder="Producto">
                    <input type="number" id="in-c" placeholder="Costo">
                    <input type="number" id="in-v" placeholder="Venta">
                    <input type="number" id="in-s" placeholder="Stock">
                </div>
                <button class="btn btn-main" onclick="agregarProd()">Guardar</button>
            </div>
            <div class="card"><table id="tab-inv"></table></div>
        </div>

        <div id="ventas" class="page">
            <h1>Ventas</h1>
            <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:20px;">
                <div class="card">
                    <input type="text" placeholder="Buscar..." onkeyup="filterVenta(this.value)">
                    <select id="sel-v" size="10" onchange="calcVenta()"></select>
                </div>
                <div class="card">
                    <input type="number" id="v-cant" value="1" min="1" oninput="calcVenta()">
                    <input type="number" id="v-desc" value="0" placeholder="Descuento COP" oninput="calcVenta()">
                    <div style="font-size:2rem; text-align:center; margin:20px 0;" id="total-v">$ 0</div>
                    <button class="btn btn-accent" onclick="realizarVenta()">Cobrar</button>
                    <button id="btn-print-act" class="btn btn-print" onclick="window.print()">
                        <i class="fas fa-print"></i> Imprimir Factura
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="ticket-print">
        <div style="text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px;">
            <h2 style="margin:0;">CONEXIONES JP</h2>
            <p style="margin:0; font-size:12px;">Soluciones Tecnológicas</p>
            <p id="t-fecha" style="font-size:10px;"></p>
        </div>
        <div style="padding: 10px 0; font-size: 14px;">
            <div style="display:flex; justify-content: space-between;">
                <span id="t-prod">Producto</span>
                <span id="t-cant">x0</span>
            </div>
            <div style="text-align: right; font-weight: bold;" id="t-subtotal">Sub: $0</div>
            <div style="text-align: right;" id="t-desc">Desc: -$0</div>
            <div style="text-align: right; border-top: 1px solid #000; font-size:18px; margin-top:5px;" id="t-total">TOTAL: $0</div>
        </div>
        <p style="text-align:center; font-size:10px; margin-top:20px;">¡Gracias por su preferencia!<br>Software gestionado por JP ERP</p>
    </div>

<script>
    const fmt = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
    let db = JSON.parse(localStorage.getItem('jp_v4')) || { prods: [], ventas: [], hist: [] };

    function showPage(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        updateUI();
    }

    function agregarProd() {
        const n = document.getElementById('in-n').value, c = +document.getElementById('in-c').value, v = +document.getElementById('in-v').value, s = +document.getElementById('in-s').value;
        if(n && v) { db.prods.push({n, c, v, s, vh:0}); save(); }
    }

    function calcVenta() {
        const i = document.getElementById('sel-v').value, cant = +document.getElementById('v-cant').value, desc = +document.getElementById('v-desc').value;
        if(i !== "") {
            const total = (db.prods[i].v * cant) - desc;
            document.getElementById('total-v').innerText = fmt.format(total);
        }
    }

    function realizarVenta() {
        const i = document.getElementById('sel-v').value, cant = +document.getElementById('v-cant').value, desc = +document.getElementById('v-desc').value;
        if(i === "") return;
        const p = db.prods[i];
        if(p.s >= cant) {
            const total = (p.v * cant) - desc;
            p.s -= cant; p.vh += cant;
            db.ventas.push({ n:p.n, v:total, g: total-(p.c*cant), c:cant });
            
            // Llenar Ticket
            document.getElementById('t-fecha').innerText = new Date().toLocaleString();
            document.getElementById('t-prod').innerText = p.n;
            document.getElementById('t-cant').innerText = "x" + cant;
            document.getElementById('t-subtotal').innerText = "Sub: " + fmt.format(p.v * cant);
            document.getElementById('t-desc').innerText = "Desc: -" + fmt.format(desc);
            document.getElementById('t-total').innerText = "TOTAL: " + fmt.format(total);
            
            document.getElementById('btn-print-act').style.display = "block";
            save();
            alert("Venta registrada. Ya puede imprimir.");
        } else alert("No hay stock");
    }

    function finalizarDia() {
        if(!db.ventas.length) return;
        const g = db.ventas.reduce((a,b)=>a+b.g, 0);
        db.hist.unshift({f: new Date().toLocaleDateString(), g});
        db.ventas = []; db.prods.forEach(p=>p.vh=0);
        save();
        alert("Cierre de caja exitoso");
    }

    function save() { localStorage.setItem('jp_v4', JSON.stringify(db)); updateUI(); }

    function updateUI() {
        const tbody = document.getElementById('tab-inv');
        tbody.innerHTML = `<tr><th>Producto</th><th>Stock</th><th>Venta</th></tr>` + db.prods.map(p => `<tr><td>${p.n}</td><td>${p.s}</td><td>${fmt.format(p.v)}</td></tr>`).join('');
        
        filterVenta("");
    }

    function filterVenta(q) {
        document.getElementById('sel-v').innerHTML = db.prods.map((p,i) => ({p,i})).filter(x => x.p.n.toLowerCase().includes(q.toLowerCase()))
            .map(x => `<option value="${x.i}">${x.p.n} (Stock: ${x.p.s})</option>`).join('');
    }

    updateUI();
</script>
</body>
</html>
